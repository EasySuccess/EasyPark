<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>MACAU CarPark</title>
    <meta name="description" content="MACAU CarPark  " />
    <meta name="author" content="MACAU CarPark" />
    <!-- <link rel="shortcut icon" href="img/favicon.png" type="image/x-icon" /> -->

    <!-- Mobile Specific Meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <!-- Style CSS -->
    <link rel="stylesheet" href="css/bootstrap.css" />
    <link rel="stylesheet" href="css/icomoon.css" />
    <link rel="stylesheet" href="css/screen.css" />
    <link rel="stylesheet" href="css/style.css" />

</head>

<body>
    <!-- Page Wrapper -->
    <div id="">
        <!-- Header -->
        <header>
            <div class="container" style="background-color: #81C7D4; height: 50px;">
                <div class="row" style="">
                    <div class="col-xs-4 col-sm-3">
                        <a class="brand" href="index.html">
                            <img src="img/epark_logo.png" alt="logo-image" />
                            <!--<h1 style="margin: 10px;">CarPark</h1>-->
                        </a>
						<a href="index.html?gps=1">
                            <img src="img/gps.png" alt="logo-image" />
                        </a>
                    </div>
                </div>
            </div>

        </header>

        <!-- Main Content -->
        <div class="content-wrapper" style="margin-top: 80px;">
		
			<div class="blackout"></div>
			
            <div class="container">
				<h1 id="bodyTop">資料載入中，請耐心等候...</h1>
                <div class="row hide" id="bodyContainer">
                    <div class="carpark-description">最後更新時間 (每10秒自動更新)：<span id="updateTime"></span></div>
                    <ul class="list-part" id="listPart">
					
                        <li class="comp">
                            <!-- <a href="#"> -->
                                <div class="list-part-img">
                                    <img class="list-img" src="img/default.jpg" onerror="this.src='img/default.jpg'">
                                </div>
                                <div class="list-part-detial">
                                    <h4></h4>
                                    <div class="detial">
                                        <img src="img/car_icon.png" alt="" />
                                        <div class="list-num"></div>
                                        <div class="list-sub">汽車位剩餘數量</div>
                                    </div>
                                    <div class="detial">
                                        <img src="img/motor_icon.png" alt="" />
                                        <div class="list-num"></div>
                                        <div class="list-sub">電單車位剩餘數量</div>
                                    </div>
                                </div>
                            <!-- </a> -->
                        </li>
						
                    </ul>
                </div>
            </div>
        </div>


    </div>

    <!-- Footer -->
    <footer class="">
        <div class="container">
            <div class="copyrights">
                <p>Copyright 2015. Designed by <a href="#" target="blank">EST</a>
                    <br />以上資料只供參考</p>
            </div>
        </div>
        </div>
    </footer>

    <nav>
        <div id="" class="fixedBar">
            <ul>
                <li class="fixedBar-li current">
                    <a href="index.html" class=""><img src="img/home.png">
                        <div>即時停車場</div>
                    </a>
                </li>
                <li class="fixedBar-li">
                    <a href="predict.html" class=""><img src="img/carpark.png" />
                        <div>停車位預測</div>
                    </a>
                </li>
				<li class="fixedBar-li">
                    <a href="monitor.html" class=""><img src="img/carpark.png" />
                        <div>停車位監測</div>
                    </a>
                </li>
                <li class="fixedBar-li">
                    <a href="map.html" class=""><img src="img/app.png" />
                        <div>地圖展示</div>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    </div>
	
</body>
<!-- Scripts -->
<script src="js/jquery-1.11.3.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/parse-1.6.7.min.js"></script>
<script src="js/moment.js"></script>
<script src="js/getUrlVars.js"></script>
<script src="js/custom.js"></script>

<script>

	$(document).ready(function() {
	
		$(".blackout").show();
		var gpsEnable = getUrlVars()["gps"];
		var template = $("#listPart").html();
		var distList;
			
		Parse.initialize("SYNJggCNxjtYuooVAiFh1cVtcT13uRISc1jtDZHN", "gkWIgX1vSMivt7B2lFqJQbEzoUZd4d73IydpX5hR");

		//Get User current location and get the list from nearest
		
		if(gpsEnable){
		
			Parse.GeoPoint.current().then(function(currentGeoLocation){
			
				$("#bodyTop").append("<br>");
				$("#bodyTop").append("成功讀取GPS資料...");
				
				console.log(currentGeoLocation);
				// ParseGeoPoint currentGeoLocation = new ParseGeoPoint(position.coords.latitude, position.coords.longitude);
				var ClassParkInfo = Parse.Object.extend("Dev_Park_Info");
				var query = new Parse.Query(ClassParkInfo);
				query.near("GeoLocation", currentGeoLocation); 
				query.select("Name");
				
				return query.find();
			}).then(function(results){
				
				distList = [];
				
				$.each(results, function(i, result){
					distList.push(result.get("Name"));
				});		

				buildBodyContainer(template, distList);			
				autoRefresh(template, 10000, distList);
				
			}, function(error){
			
				alert("讀取GPS資料失敗，請開啟GPS。停車場資料將以正常排序顯示。");
				
				buildBodyContainer(template);
				autoRefresh(template, 10000)
				
			});
			
		}else{
		
			buildBodyContainer(template);
			autoRefresh(template, 10000)
			
		}
		
	});

	function buildBodyContainer(template, distList){
	
		Parse.Cloud.run("getInstantParkingData", {}).then(function(result){
					
			console.log(result);
						
			if(!result.success){
			
				alert("未能取得停車場資料，請檢查網路連接。");
				
			}else{
			
				$("#bodyTop").append("<br>");
				$("#bodyTop").append("成功取得停車場資料...");
			
				$("#listPart").empty();
									
				console.log(distList);
				
				if(distList != undefined){
					var data = sortByDist(result.data, distList);
				}
				else{
					var data = result.data;
				}
				
				console.log(data);
				
				$.each(data, function(i, park){
					
					$("#listPart").append(template);
					
					$("#listPart li:eq(" + i + ") h4").html(park.name + "(" + getParkFee(park.name) + ")");
					$("#listPart li:eq(" + i + ") .list-img").attr("src", "img/" + park.name + ".jpg");
					$("#listPart li:eq(" + i + ") .detial:eq(0) div:eq(0)").html(park.numCarPark);
					$("#listPart li:eq(" + i + ") .detial:eq(1) div:eq(0)").html(park.numMotorPark);
					
				});
				
				var momentDate = moment();
				
				$("#updateTime").empty();
				//$("#updateTime").append(momentDate.format("YYYY-MM-DD hh:mm:ss A"));
				$("#updateTime").append(momentDate.format("hh:mm:ss A"));
				
				$("#bodyContainer").removeClass("hide");
				$("#bodyTop").addClass("hide");
				$(".blackout").hide();
			}
		
		},function(error){
		
			console.log(error);
			
		});
		
	}
	
	function autoRefresh(template, interval, distList){
	
		var Interval = setInterval(function() {
			
			buildBodyContainer(template, distList);
			
		}, interval);
		
	}
	
	function sortByDist(data, distList){
	
		var results = [];
	
		$.each(distList, function(i, name){
			$.each(data, function(j, park){
				
				if(park.name == name){
					results.push(park);
					return false;
				}					
						
			});
		});
		
		return results;
	}
	
</script>

</html>