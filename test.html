<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>MACAU CarPark</title>
    <meta name="description" content="MACAU CarPark  " />
    <meta name="author" content="MACAU CarPark" />
    <!-- <link rel="shortcut icon" href="img/favicon.png" type="image/x-icon" /> -->

    <!-- Mobile Specific Meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <!-- Style CSS -->
    <link rel="stylesheet" href="css/bootstrap.css" />
    <link rel="stylesheet" href="css/icomoon.css" />
    <link rel="stylesheet" href="css/screen.css" />
    <link rel="stylesheet" href="css/style.css" />

</head>

<body>
    <!-- Page Wrapper -->
    <div id="">
        <!-- Header -->
        <header>
            <div class="container" style="background-color: #81C7D4; height: 50px;">
                <div class="row" style="">
                    <div class="col-xs-4 col-sm-3">
                        <a class="brand" href="index.html">
                            <img src="img/epark_logo.png" alt="logo-image" />
                            <!--<h1 style="margin: 10px;">CarPark</h1>-->
                        </a>
                    </div>
                </div>
            </div>

        </header>

        <!-- Main Content -->
        <div class="content-wrapper" style="margin-top: 80px;">
		
			<div class="blackout"></div>
			
            <div class="container">
				<h1 id="gpsInfo"></h1>
				<h1 id="bodyTop">資料載入中...</h1>
                <div class="row hide" id="bodyContainer">
                    <div class="carpark-description">最後更新時間 (每10秒自動更新)：<span id="updateTime"></span></div>
                    <ul class="list-part" id="listPart">
					
                        <li class="comp">
                            <!-- <a href="#"> -->
                                <div class="list-part-img">
                                    <img class="list-img" src="img/default.jpg" onerror="this.src='img/default.jpg'">
                                </div>
                                <div class="list-part-detial">
                                    <h4></h4>
                                    <div class="detial">
                                        <img src="img/car_icon.png" alt="" />
                                        <div class="list-num"></div>
                                        <div class="list-sub">汽車位剩餘數量</div>
                                    </div>
                                    <div class="detial">
                                        <img src="img/motor_icon.png" alt="" />
                                        <div class="list-num"></div>
                                        <div class="list-sub">電單車位剩餘數量</div>
                                    </div>
                                </div>
                            <!-- </a> -->
                        </li>
						
                    </ul>
                </div>
            </div>
        </div>


    </div>

    <!-- Footer -->
    <footer class="">
        <div class="container">
            <div class="copyrights">
                <p>Copyright 2015. Designed by <a href="#" target="blank">EST</a>
                    <br />以上資料只供參考</p>
            </div>
        </div>
        </div>
    </footer>

    <nav>
        <div id="" class="fixedBar">
            <ul>
                <li class="fixedBar-li current">
                    <a href="index.html" class=""><img src="img/home.png">
                        <div>即時停車場</div>
                    </a>
                </li>
                <li class="fixedBar-li">
                    <a href="predict.html" class=""><img src="img/carpark.png" />
                        <div>預測泊車成功率</div>
                    </a>
                </li>
                <li class="fixedBar-li">
                    <a href="#" class=""><img src="img/setting.png" />
                        <div>其他</div>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    </div>
	
</body>
<!-- Scripts -->
<script src="js/jquery-1.11.3.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/parse-1.6.7.min.js"></script>
<script src="js/moment.js"></script>

<script>

	$(document).ready(function() {
	
		$(".blackout").show();
		var template = $("#listPart").html();
			
		Parse.initialize("SYNJggCNxjtYuooVAiFh1cVtcT13uRISc1jtDZHN", "gkWIgX1vSMivt7B2lFqJQbEzoUZd4d73IydpX5hR");

		buildBodyContainer(template);
		//autoRefresh(template, 10000);
		// getLocation();
		var currentGeoLocation = new Parse.GeoPoint.current;
		console.log(currentGeoLocation);
		// ParseGeoPoint currentGeoLocation = new ParseGeoPoint(position.coords.latitude, position.coords.longitude);
		var ClassParkInfo = Parse.Object.extend("Dev_Park_Info");
		var query = new Parse.Query(ClassParkInfo);
		// query.near("GeoLocation", currentGeoLocation); 
		
		query.find().then(function(results){
			console.log(results);
			$.each(results, function(i, result){
				$("#gpsInfo").append(result.get("Name"));
			});			
		});
		
	});

	function buildBodyContainer(template){
	
		Parse.Cloud.run("getInstantParkingData", {}).then(function(result){
					
			console.log(result);
						
			if(!result.success){
			
				alert("讀取資料失敗。");
				
			}else{
			
				$("#listPart").empty();
					
				var data = result.data;
				
				$.each(data, function(i, park){
					
					$("#listPart").append(template);
					
					$("#listPart li:eq(" + i + ") h4").html(park.name + "(" + getParkFee(park.name) + ")");
					$("#listPart li:eq(" + i + ") .list-img").attr("src", "img/" + park.name + ".jpg");
					$("#listPart li:eq(" + i + ") .detial:eq(0) div:eq(0)").html(park.numCarPark);
					$("#listPart li:eq(" + i + ") .detial:eq(1) div:eq(0)").html(park.numMotorPark);
					
				});
				
				var momentDate = moment();
				
				$("#updateTime").empty();
				//$("#updateTime").append(momentDate.format("YYYY-MM-DD hh:mm:ss A"));
				$("#updateTime").append(momentDate.format("hh:mm:ss A"));
				
				$("#bodyContainer").removeClass("hide");
				$("#bodyTop").addClass("hide");
				$(".blackout").hide();
			}
		
		},function(error){
		
			console.log(error);
			
		});
		
	}
	
	function autoRefresh(template, interval){
	
		var Interval = setInterval(function() {
			
			buildBodyContainer(template);
			
		}, interval);
		
	}
	
	function getParkFee(name){
				
		feeOf2 = ["栢麗", "下環街市"];
		feeOf3 = ["栢港","栢景","栢威","栢蕙","污水處理站","華士古達嘉馬花園 ","祐漢公園","科學館","麗都","交通事務局大樓","青翠樓","望善樓","河邊新街","快富樓","蓮花路","永寧街","氹仔中央公園","氹仔客運碼頭","望賢樓","湖畔大廈","居雅大廈","業興大廈","樂群樓","青葱大廈"]
		feeOf6 = ["栢佳","栢濤","栢寧","栢力","栢樂","南灣(栢湖)","宋玉生廣場","藝園","亞馬喇前地","何賢公園","馬六甲街","黑橋街","快達樓"]
		
		if(feeOf2.indexOf(name) >= 0){
			return "$2";
		}else if(feeOf6.indexOf(name) >= 0){
			return "$6";
		}else{
			return "$3";
		}
		
	}
	
	function getLocation() {
		$("#gpsInfo").append("Calling GPS");
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(showPosition);
		} else {
			$("#gpsInfo").append("Geolocation is not supported by this browser.");
		}
	}
	
	function showPosition(position) {
		// $("#gpsInfo").append("Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude);
		
		var currentGeoLocation = new Parse.GeoPoint.current;
		console.log(currentGeoLocation);
		// ParseGeoPoint currentGeoLocation = new ParseGeoPoint(position.coords.latitude, position.coords.longitude);
		var ClassParkInfo = Parse.Object.extend("Dev_Park_Info");
		var query = new Parse.Query(ClassParkInfo);
		query.near("GeoLocation", currentGeoLocation); 
		
		query.find().then(function(results){
			console.log(results);
			$.each(results, function(i, result){
				$("#gpsInfo").append(result.get("Name"));
			});			
		});
		
	}
	
	function getDistance(lat1,lon1,lat2,lon2) {
		var R = 6371; // Radius of the earth in km
		var dLat = deg2rad(lat2-lat1);  // deg2rad below
		var dLon = deg2rad(lon2-lon1); 
		var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
				Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
				Math.sin(dLon/2) * Math.sin(dLon/2); 
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
		var d = R * c; // Distance in km
		return d;
	}

	function deg2rad(deg) {
		return deg * (Math.PI/180)
	}
	
	
</script>

</html>