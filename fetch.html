<!DOCTYPE html>
<html>
	<head>
		<title>Page Title</title>
	</head>
	<body>
		<div><big>Fetch Car Park Information from DSAT</big></div>
		<div>This page must keep on so as to keep schedule jobs proceed</div>
		<div id="interval"></div>
		<div id="start-time"></div></br>
		<div id="content"></div>
	</body>
</html>
<script src="http://www.parsecdn.com/js/parse-1.5.0.min.js"></script>
<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
<script>
	var interval_min = 5;
	var interval_ms = interval_min * 60000;

	$( document ).ready ( function() {
		
		$("#start-time").html("Start time: " + new Date());
		$("#interval").html("Interval: " + interval_min + " minutes");
		
		Parse.initialize("SYNJggCNxjtYuooVAiFh1cVtcT13uRISc1jtDZHN", "gkWIgX1vSMivt7B2lFqJQbEzoUZd4d73IydpX5hR");

		setInterval(function(){
			
			$.ajax({ url: 'proxy.php',
				success: function(data) { 
					// console.log("Success"); 
					// console.log(data); 
					var numRecord = 0;
					var parser=new DOMParser();
					var xmlDoc=parser.parseFromString(data,"text/xml");
					$xml = $(xmlDoc)
					$carParkInfo = $xml.find(".MainContentText >table >tr");
					var carParkStat = Parse.Object.extend("Dev_Carpark_Stat");
					
					$carParkInfo.each(function(index){
						if(index > 0){
							numRecord = index;
						
							var carParkStatObj = new carParkStat();
							
							$(this).find("td").each(function(index2){

								var value = $.trim($(this).text());
								
								if(value.length){
									switch(index2){
										case 0:
											carParkStatObj.set("name", value);
											break;
										case 1:
											if(!isNaN(parseInt(value))){
												carParkStatObj.set("num_carpark", parseInt(value));
											}else{
												carParkStatObj.set("num_carpark", 0);
											}
											break;
										case 2:
											if(!isNaN(parseInt(value))){
												carParkStatObj.set("num_motorpark", parseInt(value));
											}else{
												carParkStatObj.set("num_motorpark", 0);
											}
											break;
										case 3:
											//Update Time: Use the default updatedAt
											break;
										default:
											break;
									}
								}
							});
							carParkStatObj.save();
						}
					});
					
					// console.log("Created " + numRecord " records at " + new Date());
					$("#content").append("<div>Created " + numRecord + " records at " + new Date() + "</div>");
					
				} ,
				error: function(error){
					console.log("Error");
					console.log(error);
				}
			});
			
		 }, interval_ms);
		 
		 // console.log("End of Code");
		 
	});

</script>
