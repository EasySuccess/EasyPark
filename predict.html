<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>MACAU CarPark</title>
    <meta name="description" content="MACAU CarPark  " />
    <meta name="author" content="MACAU CarPark" />
    <!-- <link rel="shortcut icon" href="img/favicon.png" type="image/x-icon" /> -->

    <!-- Mobile Specific Meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <!-- Style CSS -->
    <link rel="stylesheet" href="css/bootstrap.css" />
    <link rel="stylesheet" href="css/icomoon.css" />
    <link rel="stylesheet" href="css/screen.css" />
    <link rel="stylesheet" href="css/style.css" />

</head>

<body>
    <!-- Page Wrapper -->
    <div id="">
        <!-- Header -->
        <header>
            <div class="container" style="background-color: #81C7D4; height: 50px;">
                <div class="row">
                    <div class="col-xs-4 col-sm-3">
                        <a class="brand" href="index.html">
                            <img src="img/epark_logo.png" alt="logo-image" />
                            <!--<h1 style="margin: 10px;">CarPark</h1>-->
                        </a>
                    </div>
                    <div class="col-xs-8 col-sm-9">
                        <div class="predict-topBar">
                            <span data-toggle="modal" data-target="#predictModal" style="cursor: pointer;">選取</span>
                        </div>
                    </div>
                </div>
            </div>

        </header>

        <!-- Main Content -->
        <div class="content-wrapper" style="margin-top: 80px;">
            <div class="container">
				<h1 id="bodyTop">
					<div>提示：</div>
					<div>請先按右上方按鍵選取停車場及預計到達時間，</div>
					<div>結果將會以泊車成功率顯示，</div>
					<div>泊車成功率僅供參考，建議駕駛人士提早準備。</div>
				</h1>

                <div class="row hide"  id="bodyContainer">
                    <div class="carpark-description">搜索條件:<span id="criteria"></span></div>
                    <ul class="list-part" id="listPart">
                        <li class="comp">
                            <!-- <a href="#"> -->
                                <div class="list-part-img">
                                    <img class="list-img" src="img/default.jpg" onerror="this.src='img/default.jpg'">
                                </div>
                                <div class="list-part-detial">
                                    <h4></h4>
                                    <div class="detial">
                                        <img src="img/car_icon.png" alt="" />
                                        <div class="list-num"></div>
                                        <div class="list-sub"></div>
                                        <!-- <div class="list-sub">汽車位剩餘數量</div> -->
                                    </div>
                                    <div class="detial">
                                        <img src="img/motor_icon.png" alt="" />
                                        <div class="list-num"></div>
                                        <div class="list-sub"></div>
                                        <!-- <div class="list-sub">電單車位剩餘數量</div> -->
                                    </div>
                                </div>
                            <!-- </a> -->
                        </li>
                    </ul>
					
					<h4>附近停車場 (由近至遠)</h4>
					<ul class="list-part" id="listNearBy">
                    </ul>
                </div>
            </div>
        </div>


    </div>

    <!-- Footer -->
    <footer class="">
        <div class="container">
            <div class="copyrights">
                <p>Copyright 2015. Designed by <a href="#" target="blank">EST</a>
                    <br />以上資料只供參考</p>
            </div>
        </div>
        </div>
    </footer>

    <nav>
        <div id="" class="fixedBar">
            <ul>
                <li class="fixedBar-li">
                    <a href="index.html" class=""><img src="img/home.png">
                        <div>即時停車場</div>
                    </a>
                </li>
                <li class="fixedBar-li current">
                    <a href="predict.html" class=""><img src="img/carpark.png" />
                        <div>預測泊車成功率</div>
                    </a>
                </li>
                <li class="fixedBar-li">
                    <a href="map.html" class=""><img src="img/app.png" />
                         <div>地圖展示</div>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    </div>

    <!--SEARCH-->
    <div class="modal fade" id="predictModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h1 style="text-align: center;">選取資料</h1>
                </div>

                <div class="blackout"></div>

                <form role="form" data-toggle="validator" class="RegisterLogin" id="searchForm">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="type" class="control-label">停車場：</label>
                            <select class="form-control" id="parkName">
								  <option value="下環街市">下環街市</option>
								  <option value="永寧街">永寧街</option>
								  <option value="氹仔中央公園">氹仔中央公園</option>
								  <option value="交通事務局大樓">交通事務局大樓</option>
								  <option value="何賢公園">何賢公園</option>
								  <option value="宋玉生廣場">宋玉生廣場</option>
								  <option value="快富樓">快富樓</option>
								  <option value="居雅大廈">居雅大廈</option>
								  <option value="亞馬喇前地">亞馬喇前地</option>
								  <option value="馬六甲街">馬六甲街</option>
								  <option value="河邊新街">河邊新街</option>
								  <option value="青翠樓">青翠樓</option>
								  <option value="南灣(栢湖)">南灣(栢湖)</option>
								  <option value="青葱大廈">青葱大廈</option>
								  <option value="科學館">科學館</option>
								  <option value="栢佳">栢佳</option>
								  <option value="栢港">栢港</option>
								  <option value="栢寧">栢寧</option>
								  <option value="栢樂">栢樂</option>
								  <option value="栢濤">栢濤</option>
								  <option value="栢蕙">栢蕙</option>
								  <option value="栢麗">栢麗</option>
								  <option value="栢威">栢威</option>
								  <option value="祐漢公園">祐漢公園</option>
								  <option value="望善樓">望善樓</option>
								  <option value="黑橋街">黑橋街</option>
								  <option value="望賢樓">望賢樓</option>
								  <option value="湖畔大廈">湖畔大廈</option>
								  <option value="業興大廈">業興大廈</option>
								  <option value="蓮花路">蓮花路</option>
								  <option value="藝園">藝園</option>
								  <option value="樂群樓">樂群樓</option>
								  <option value="麗都">麗都</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="date" class="control-label">日期：</label>
                            <input type="date" id="inputDate" required></input>
                        </div>
                        <div class="form-group">
                            <label for="time" class="control-label">時間：</label>
                            <input type="time" id="inputTime" required></input>
                        </div>
                    </div>
                    <div class="modal-footer form-group">
                        <button type="submit" class="btn theme-btn-2">搜索</button>
                        <button type="close" class="btn theme-btn-2" data-dismiss="modal">取消</button>
                        <!-- <button type="submit" class="btn theme-btn-2" data-dismiss="modal" data-toggle="modal" data-target="#loginModal">搜索</button> -->
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!--[end]SEARCH-->

</body>

<!-- Scripts -->
<script src="js/jquery-1.11.3.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/parse-1.6.7.min.js"></script>
<script src="js/moment.js"></script>
<script src="js/getUrlVars.js"></script>
<script src="js/custom.js"></script>


<script>
	$(document).ready(function() {
	
		Parse.initialize("SYNJggCNxjtYuooVAiFh1cVtcT13uRISc1jtDZHN", "gkWIgX1vSMivt7B2lFqJQbEzoUZd4d73IydpX5hR");
	
		//Preload in the search form
		if(getStoredValue("name") != null){
			
			var cacheName = getStoredValue("name");
			var cacheDate = getStoredValue("date");
			
			var date = moment(new Date(cacheDate));
			$("#inputDate").val(date.format('YYYY-MM-DD'));
			$("#inputTime").val(date.format("HH:MM"));
			
			$('select option[value="' + cacheName + '"]').attr("selected",true);
		}else{
			var today = moment();
			$("#inputDate").val(today.format('YYYY-MM-DD'));
			$("#inputTime").val(today.format("HH:MM"));
		}
	
		var result = JSON.parse(getStoredValue("result"));
		
		//Display result only after searchForm store value in localStorage
		if( result != null ){
			
			console.log(result);
					
			if(!result.success){
			
				alert("讀取資料失敗。");
				
			}else{					
								
				var template = $("#listPart").html();
				$("#listPart").empty();
				$("#listNearBy").empty();
					
				var data = result.data;
									
				$("#listPart").append(template);
				$("#listPart li:eq(0) h4").html(data.name);
				$("#listPart li:eq(0) .list-img").attr("src", "img/" + data.name + ".jpg");
				// $("#listPart li:eq(0) .detial:eq(0) div:eq(0)").html(data.carSuccessRate + "% (平均" + data.numCarPark + "個)");
				// $("#listPart li:eq(0) .detial:eq(1) div:eq(0)").html(data.motorSuccessRate + "% (平均" + data.numMotorPark + "個)");
				
				$("#listPart li:eq(0) .detial:eq(0) div:eq(0)").html(data.carWeightedSuccessRate + "%");
				$("#listPart li:eq(0) .detial:eq(0) div:eq(1)").html("平均" + data.numWeightedCarPark + "個");
				$("#listPart li:eq(0) .detial:eq(0) div:eq(0)").css('color', getColorStyle(data.carWeightedSuccessRate));
				
				$("#listPart li:eq(0) .detial:eq(1) div:eq(0)").html(data.motorWeightedSuccessRate + "%");
				$("#listPart li:eq(0) .detial:eq(1) div:eq(1)").html("平均" + data.numWeightedMotorPark + "個");
				$("#listPart li:eq(0) .detial:eq(1) div:eq(0)").css('color', getColorStyle(data.motorWeightedSuccessRate));
				
			
				var criteria = result.criteria;
				var momentDate = moment(criteria.dateTime);
				
				$("#criteria").empty();
				$("#criteria").append(criteria.name + ", " + momentDate.format("YYYY-MM-DD hh:mm A"));				
				
				
				var date = momentDate.toDate();
				var dayOfWeek = criteria.dayOfWeek
				var nearbyPark = data.nearby_park;
				var promise = Parse.Promise.as();

				$.each(nearbyPark, function(i, nearParkName){
					
					promise = promise.then(function(){
						
						return Parse.Cloud.run("getPredictParkingData", 
							{
								dateTime: date, 
								location: nearParkName,
								dayOfWeek: dayOfWeek,
								skipNearby: true
							});
							
					}).then(function(result){
						
						console.log(result);
						
						if(result.success){

								var data = result.data;
													
								$("#listNearBy").append(template);								
								$("#listNearBy li:eq(" + i + ") h4").html(data.name);
								$("#listNearBy li:eq(" + i + ") .list-img").attr("src", "img/" + data.name + ".jpg");
								
								//$("#listNearBy li:eq(" + i + ") .detial:eq(0) div:eq(0)").html(data.carWeightedSuccessRate + "% (平均" + data.numWeightedCarPark + "個)");
								//$("#listNearBy li:eq(" + i + ") .detial:eq(1) div:eq(0)").html(data.motorWeightedSuccessRate + "% (平均" + data.numWeightedMotorPark + "個)");
								
								$("#listNearBy li:eq(" + i + ") .detial:eq(0) div:eq(0)").html(data.carWeightedSuccessRate + "%");
								$("#listNearBy li:eq(" + i + ") .detial:eq(0) div:eq(1)").html("平均" + data.numWeightedCarPark + "個");
								$("#listNearBy li:eq(" + i + ") .detial:eq(0) div:eq(0)").css('color', getColorStyle(data.carWeightedSuccessRate));
								
								$("#listNearBy li:eq(" + i + ") .detial:eq(1) div:eq(0)").html(data.motorWeightedSuccessRate + "%");
								$("#listNearBy li:eq(" + i + ") .detial:eq(1) div:eq(1)").html("平均" + data.numWeightedMotorPark + "個");
								$("#listNearBy li:eq(" + i + ") .detial:eq(1) div:eq(0)").css('color', getColorStyle(data.motorWeightedSuccessRate));
							
						}else{
						
								$("#listNearBy").append(template);
								$("#listNearBy li:eq(" + i + ")").hide();
								
						}
						
					}, function(error){
						console.log(error);
					});
				})
				
			}
			
			$("#bodyContainer").removeClass("hide");
			$("#bodyTop").addClass("hide");
			
			//Remove result from localStorage
			removeStoredValue("result");
		}

		$("#searchForm").submit(function(e) {
	
			if (!e.isDefaultPrevented()) {
						
				$(".blackout").show();
				var name = $("#parkName").val();
				var momentDate = moment($("#inputDate").val() + " " + $("#inputTime").val(), "YYYY-MM-DD HH:mm");
				var date = momentDate.toDate();
				var dayOfWeek = getDayOfWeek(date);
				
				storeValue("name", name);
				storeValue("date", date);
								
				Parse.Cloud.run("getPredictParkingData", 
					{
						dateTime: date, 
						location: name,
						dayOfWeek: dayOfWeek,
						skipNearby: false
					}).then(function(result){
					
					storeValue("result", JSON.stringify(result));					

					window.location.reload();
					
				}, function(error){
					console.log(error);
				});
				
				e.preventDefault();
			}
			
		});
		
	});
	

	
</script>


</html>