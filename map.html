<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>MACAU CarPark</title>
    <meta name="description" content="MACAU CarPark  " />
    <meta name="author" content="MACAU CarPark" />
    <!-- <link rel="shortcut icon" href="img/favicon.png" type="image/x-icon" /> -->

    <!-- Mobile Specific Meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <!-- Style CSS -->
    <link rel="stylesheet" href="css/bootstrap.css" />
    <link rel="stylesheet" href="css/icomoon.css" />
    <link rel="stylesheet" href="css/screen.css" />
    <link rel="stylesheet" href="css/style.css" />

</head>

<body>
    <!-- Page Wrapper -->
    <div id="">
        <!-- Header -->
        <header>
            <div class="container" style="background-color: #81C7D4; height: 50px;">
                <div class="row" style="">
                    <div class="col-xs-4 col-sm-3">
                        <a class="brand" href="index.html">
                            <img src="img/epark_logo.png" alt="logo-image" />
                            <!--<h1 style="margin: 10px;">CarPark</h1>-->
                        </a>
                    </div>
                </div>
            </div>

        </header>

        <!-- Main Content -->
        <div class="content-wrapper" style="margin-top: 80px;">
		
			<div class="blackout"></div>
			
            <div class="container">
				<h1 id="bodyTop">資料載入中，請耐心等候...</h1>
				<h3 class="hide" id="bodyTop2"><img src="img/poi.png" width="32" height="32" alt="logo-image" />你的位置</h3>
                <div class="row" id="bodyContainer">
					<div class="carpark-description hide" id="updateTimeDiv">最後更新時間 (每5分鐘自動更新)：<span id="updateTime"></span></div>
					<div id="map-canvas" style="width:100%; height:400px;"></div>
                </div>
            </div>
        </div>


    </div>

    <!-- Footer -->
    <footer class="">
        <div class="container">
            <div class="copyrights">
                <p>Copyright 2015. Designed by <a href="#" target="blank">EST</a>
                    <br />以上資料只供參考</p>
            </div>
        </div>
        </div>
    </footer>

    <nav>
        <div id="" class="fixedBar">
            <ul>
                <li class="fixedBar-li">
                    <a href="index.html" class=""><img src="img/home.png">
                        <div>即時停車場</div>
                    </a>
                </li>
                <li class="fixedBar-li">
                    <a href="predict.html" class=""><img src="img/carpark.png" />
                        <div>預測泊車成功率</div>
                    </a>
                </li>
                <li class="fixedBar-li current">
                    <a href="map.html" class=""><img src="img/app.png" />
                        <div>地圖展示</div>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    </div>
	
</body>
<!-- Scripts -->
<script src="js/jquery-1.11.3.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/parse-1.6.7.min.js"></script>
<script src="js/moment.js"></script>
<script src="js/getUrlVars.js"></script>
<script src="js/custom.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>

<script>

	$(document).ready(function() {
	
		$(".blackout").show();
		
		Parse.initialize("SYNJggCNxjtYuooVAiFh1cVtcT13uRISc1jtDZHN", "gkWIgX1vSMivt7B2lFqJQbEzoUZd4d73IydpX5hR");
		
		buildMap();
		// autoRefresh(300000);
				
	});	
	
	function buildMap(){
		
		return new Promise(function(resolve, reject){
		
			Parse.GeoPoint.current().then(function(currentGeoLocation){
			
				$("#bodyTop").append("<br>");
				$("#bodyTop").append("成功讀取GPS資料...");
			
				console.log(currentGeoLocation);		
				getParkInfo(currentGeoLocation);
				
				resolve(currentGeoLocation);
			}, function(error){
			
				alert("讀取GPS資料失敗，請開啟GPS。");
				//getParkInfo();
				reject();
				
			});
		
		});
	}
	
	function getParkInfo(currentGeoLocation){
	
		Parse.Cloud.run("getInstantParkingData", {}).then(function(result){
					
			console.log(result);
						
			if(!result.success){
			
				alert("未能取得停車場資料，請檢查網路連接。");
				
			}else{
			
				$("#bodyTop").append("<br>");
				$("#bodyTop").append("成功取得停車場資料...");
			
				var data = result.data;	
				console.log(data);
				$.each(data, function(j, park){
					
					console.log(park.name);
					
				});
				
			
				var geoList = [];
				var nameList = [];
				var vacancyList = [];
				
				var ClassParkInfo = Parse.Object.extend("Dev_Park_Info");
				var query = new Parse.Query(ClassParkInfo);
				query.select("Name", "GeoLocation");
				
				query.find().then(function(results){
					
					$.each(results, function(i, result){
						geoList.push(result.get("GeoLocation"));
						nameList.push(result.get("Name"));
						// console.log(geoList.length);
					});	
				
					console.log(geoList);
					console.log(nameList);
					
					$.each(nameList, function(i, name){
					
						$.each(data, function(j, park){
														
							if(name == park.name){
								vacancyList.push(park.numCarPark);
								return false;
							}
							
						});
						
					});
					
					console.log(vacancyList.length);
					console.log(vacancyList);
					
					var momentDate = moment();
					
					$("#updateTime").empty();
					//$("#updateTime").append(momentDate.format("YYYY-MM-DD hh:mm:ss A"));
					$("#updateTime").append(momentDate.format("hh:mm:ss A"));
					
					// $("#updateTimeDiv").removeClass("hide");
					$("#bodyTop").addClass("hide");
					$("#bodyTop2").removeClass("hide");
					$(".blackout").hide();
					
					buildGoogleMap(geoList, nameList, vacancyList, currentGeoLocation, "map-canvas");
				});
			}
		
		},function(error){
		
			alert("未能取得停車場資料，請檢查網路連接。");
			
		});
		
	}
	
	function autoRefresh(interval){
	
		var Interval = setInterval(function() {
			
			buildMap();
			
		}, interval);
		
	}

	function buildGoogleMap(geoList, nameList, vacancyList, currentGeoLocation, argId){
		if ($('#' + argId).length) {
			var map,service;

			if(currentGeoLocation != undefined){
				var latlng = new google.maps.LatLng(currentGeoLocation._latitude, currentGeoLocation._longitude);
				var myOptions = {
					zoom: 16,
					center: latlng,
					mapTypeId: google.maps.MapTypeId.ROADMAP,
					scrollwheel: false
				};
				map = new google.maps.Map(document.getElementById(argId), myOptions);
				
				var marker = new google.maps.Marker({
					position: latlng,
					map: map,
					icon: 'http://maps.google.com/mapfiles/kml/shapes/poi.png'
				});
				marker.setMap(map);
			}
			
			$.each(geoList, function(i, geo){
				if(i == 0 && currentGeoLocation == undefined){
					var latlng = new google.maps.LatLng(geo._latitude, geo._longitude);
					var myOptions = {
						zoom: 16,
						center: latlng,
						mapTypeId: google.maps.MapTypeId.ROADMAP,
						scrollwheel: false
					};
					map = new google.maps.Map(document.getElementById(argId), myOptions);
					
					var marker = new google.maps.Marker({
						position: latlng,
						icon: "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=" + vacancyList[i] + "|FE6256|000000",
						map: map,
					});
					marker.setMap(map);
				}else{
					var latlng = new google.maps.LatLng(geo._latitude, geo._longitude);
					
					var marker = new google.maps.Marker({
						position: latlng,
						icon: "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=" + vacancyList[i] + "|FE6256|000000",
						map: map
					});
					
					marker.setMap(map);
				}
			})

			$('a[href="#baidu-map-tab"]').on('shown.bs.tab', function(e) {
				google.maps.event.trigger(map, 'resize');
				map.setCenter(latlng);
			});
		}
	}
	
</script>

</html>