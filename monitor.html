<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>MACAU CarPark</title>
    <meta name="description" content="MACAU CarPark  " />
    <meta name="author" content="MACAU CarPark" />
    <!-- <link rel="shortcut icon" href="img/favicon.png" type="image/x-icon" /> -->

    <!-- Mobile Specific Meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <!-- Style CSS -->
    <link rel="stylesheet" href="css/bootstrap.css" />
    <link rel="stylesheet" href="css/icomoon.css" />
    <link rel="stylesheet" href="css/screen.css" />
    <link rel="stylesheet" href="css/style.css" />

</head>

<body>
    <!-- Page Wrapper -->
    <div id="">
        <!-- Header -->
        <header>
            <div class="container" style="background-color: #81C7D4; height: 50px;">
                <div class="row">
                    <div class="col-xs-4 col-sm-3">
                        <a class="brand" href="index.html">
                            <img src="img/epark_logo.png" alt="logo-image" />
                            <!--<h1 style="margin: 10px;">CarPark</h1>-->
                        </a>
                    </div>
                    <div class="col-xs-8 col-sm-9">
                        <div class="predict-topBar">
                            <span data-toggle="modal" data-target="#predictModal" style="cursor: pointer;">選取</span>
                        </div>
                    </div>
                </div>
            </div>

        </header>

        <!-- Main Content -->
        <div class="content-wrapper" style="margin-top: 80px;">
            <div class="container">
				<h1 id="bodyTop">
					<div>提示：</div>
					<div>請先按右上方按鍵選取停車場以作監測，當目標停車場車位數量滿足設定值時，會有信息提示。</div>
				</h1>

                <div class="row hide"  id="bodyContainer">
                    <div class="carpark-description">監測條件：<span id="monitorThreshold"></span>個車位</div>
                    <div class="carpark-description">最後更新時間 (每10秒自動更新)：<span id="updateTime"></span></div>
                    <ul class="list-part" id="listPart">
                        <li class="comp">
                            <!-- <a href="#"> -->
                                <div class="list-part-img">
                                    <img class="list-img" src="img/default.jpg" onerror="this.src='img/default.jpg'">
                                </div>
                                <div class="list-part-detial">
                                    <h4></h4>
                                    <div class="detial">
                                        <img src="img/car_icon.png" alt="" />
                                        <div class="list-num"></div>
                                        <div class="list-sub">汽車位剩餘數量</div>
                                    </div>
                                    <div class="detial">
                                        <img src="img/motor_icon.png" alt="" />
                                        <div class="list-num"></div>
                                        <div class="list-sub">電單車位剩餘數量</div>
                                    </div>
                                </div>
                            <!-- </a> -->
                        </li>
                    </ul>
                </div>
            </div>
        </div>


    </div>

    <!-- Footer -->
    <footer class="">
        <div class="container">
            <div class="copyrights">
                <p>Copyright 2015. Designed by <a href="#" target="blank">EST</a>
                    <br />以上資料只供參考</p>
            </div>
        </div>
        </div>
    </footer>

    <nav>
        <div id="" class="fixedBar">
            <ul>
                <li class="fixedBar-li">
                    <a href="index.html" class=""><img src="img/home.png">
                        <div>即時停車場</div>
                    </a>
                </li>
                <li class="fixedBar-li">
                    <a href="predict.html" class=""><img src="img/carpark.png" />
                        <div>預測泊車成功率</div>
                    </a>
                </li>
				<li class="fixedBar-li current">
                    <a href="monitor.html" class=""><img src="img/carpark.png" />
                        <div>實時監測車位數量</div>
                    </a>
                </li>
                <li class="fixedBar-li">
                    <a href="map.html" class=""><img src="img/app.png" />
                         <div>地圖展示</div>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    </div>

    <!--SEARCH-->
    <div class="modal fade" id="predictModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h1 style="text-align: center;">選取資料</h1>
                </div>

                <div class="blackout"></div>

                <form role="form" data-toggle="validator" class="RegisterLogin" id="searchForm">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="type" class="control-label">停車場：</label>
                            <select class="form-control" id="parkName">
								  <option value="下環街市">下環街市</option>
								  <option value="永寧街">永寧街</option>
								  <option value="氹仔中央公園">氹仔中央公園</option>
								  <option value="交通事務局大樓">交通事務局大樓</option>
								  <option value="何賢公園">何賢公園</option>
								  <option value="宋玉生廣場">宋玉生廣場</option>
								  <option value="快富樓">快富樓</option>
								  <option value="居雅大廈">居雅大廈</option>
								  <option value="亞馬喇前地">亞馬喇前地</option>
								  <option value="馬六甲街">馬六甲街</option>
								  <option value="河邊新街">河邊新街</option>
								  <option value="青翠樓">青翠樓</option>
								  <option value="南灣(栢湖)">南灣(栢湖)</option>
								  <option value="青葱大廈">青葱大廈</option>
								  <option value="科學館">科學館</option>
								  <option value="栢佳">栢佳</option>
								  <option value="栢港">栢港</option>
								  <option value="栢寧">栢寧</option>
								  <option value="栢樂">栢樂</option>
								  <option value="栢濤">栢濤</option>
								  <option value="栢蕙">栢蕙</option>
								  <option value="栢麗">栢麗</option>
								  <option value="栢威">栢威</option>
								  <option value="祐漢公園">祐漢公園</option>
								  <option value="望善樓">望善樓</option>
								  <option value="黑橋街">黑橋街</option>
								  <option value="望賢樓">望賢樓</option>
								  <option value="湖畔大廈">湖畔大廈</option>
								  <option value="業興大廈">業興大廈</option>
								  <option value="蓮花路">蓮花路</option>
								  <option value="藝園">藝園</option>
								  <option value="樂群樓">樂群樓</option>
								  <option value="麗都">麗都</option>
                            </select>
                        </div>
                    </div>
					<div class="form-group">
                            <label for="date" class="control-label">車位數量：</label>
                            <input type="number" id="threshold" required></input>
                        </div>
                    <div class="modal-footer form-group">
                        <button type="submit" class="btn theme-btn-2">監測</button>
                        <button type="close" class="btn theme-btn-2" data-dismiss="modal">取消</button>
                        <!-- <button type="submit" class="btn theme-btn-2" data-dismiss="modal" data-toggle="modal" data-target="#loginModal">搜索</button> -->
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!--[end]SEARCH-->

</body>

<!-- Scripts -->
<script src="js/jquery-1.11.3.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/parse-1.6.7.min.js"></script>
<script src="js/moment.js"></script>
<script src="js/getUrlVars.js"></script>
<script src="js/custom.js"></script>


<script>
	$(document).ready(function() {
	
		Parse.initialize("SYNJggCNxjtYuooVAiFh1cVtcT13uRISc1jtDZHN", "gkWIgX1vSMivt7B2lFqJQbEzoUZd4d73IydpX5hR");
	
		if(getStoredValue("name") != null){
			
			var cacheName = getStoredValue("name");
			var cacheThreshold = getStoredValue("threshold");
			
			$('select option[value="' + cacheName + '"]').attr("selected",true);
			$("#threshold").val(cacheThreshold);
			
		}
	
		var name = getStoredValue("name");	
		var threshold = getStoredValue("threshold");	
		var result = JSON.parse(getStoredValue("result"));
		
		//Display result only after searchForm store value in localStorage
		if( result != null ){
			
			console.log(result);
					
			if(!result.success){
			
				alert("未能取得停車場資料，請檢查網路連接。");
				console.log("error");
				
			}else{
								
				var template = $("#listPart").html();
				$("#listPart").empty();
					
				var data = result.data;
									
				$.each(data, function(i, park){
					
					if(park.name == name){
										
						$("#listPart").append(template);
									
						$("#listPart li:eq(" + 0 + ") h4").html(park.name + "(" + getParkFee(park.name) + ")");
						$("#listPart li:eq(" + 0 + ") .list-img").attr("src", "img/" + park.name + ".jpg");
						$("#listPart li:eq(" + 0 + ") .detial:eq(0) div:eq(0)").html(park.numCarPark);
						$("#listPart li:eq(" + 0 + ") .detial:eq(1) div:eq(0)").html(park.numMotorPark);
							
						if(park.numCarPark >= threshold){
							alert("有車位！" + park.name + "目前車位數量有" + park.numCarPark);
						}
						
						return false;
					}
				});
						
			}
			
			
			$("#monitorThreshold").empty();
			$("#monitorThreshold").html(threshold);
			
			var momentDate = moment();
			$("#updateTime").empty();
			//$("#updateTime").append(momentDate.format("YYYY-MM-DD hh:mm:ss A"));
			$("#updateTime").append(momentDate.format("hh:mm:ss A"));
			
			$("#bodyContainer").removeClass("hide");
			$("#bodyTop").addClass("hide");
			$(".blackout").hide();
			
			//Remove result from localStorage
			removeStoredValue("result");
			
		}

		$("#searchForm").submit(function(e) {
	
			if (!e.isDefaultPrevented()) {
						
				$(".blackout").show();
				var name = $("#parkName").val();
				var threshold = $("#threshold").val();
				storeValue("name", name);
				storeValue("threshold", threshold);
								
				getParkingData();
				
				e.preventDefault();
			}
			
		});
		
		autoRefresh(10000);
		
	});
	
	function getParkingData(){
	
		Parse.Cloud.run("getInstantParkingData", {}).then(function(result){
					
			console.log(result);
						
			if(!result.success){
			
				alert("未能取得停車場資料，請檢查網路連接。");
				console.log("error");
				
			}else{
			
				storeValue("result", JSON.stringify(result));					

				window.location.reload();
			
			}
				
		
		},function(error){
		
			console.log(error);
			
		});
		
	}
	
	function autoRefresh(interval){
	
		var Interval = setInterval(function() {
			
			getParkingData();
			
		}, interval);
		
	}
	

	
</script>


</html>